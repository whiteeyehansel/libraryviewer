{% extends 'library/base.html' %}

{% block title %}Library Index{% endblock %}

{% block content %}

    <div id="entries" class="row g-4">
        {% include 'library/partials/_entries.html' with entries=entries %}
    </div>

    <div id="loading" class="text-center py-4" style="display: none;">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2 text-muted">Loading more…</p>
    </div>

    <button id="goUpBtn" class="btn btn-primary shadow"
            style="position: fixed; bottom: 30px; right: 30px; display: none; z-index: 1000;">
        ↑ GO UP
    </button>
<script>
/* ------ submit sidebar without losing other params (page etc.) ---------- */
document.getElementById('filterForm').addEventListener('submit', e=>{
  e.preventDefault();
  const params = new URLSearchParams(new FormData(e.target));
  window.location = `?${params.toString()}`;   // full reload resets scroll/infinite
});
</script>

<script>
let page = 2;
let loading = false;
let doneScrolling = false;

window.addEventListener('scroll', () => {
    if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500 && !loading && !doneScrolling) {
        loading = true;
        $('#loading').show();

        $.ajax({
            url: `?page=${page}&q={{ query }}`,
                success: function(data, status, xhr) {
                    const temp = document.createElement('div');
                    temp.innerHTML = data;
                    const newCards = temp.querySelectorAll('.col-6, .col-md-4, .col-lg-3');

                    if (newCards.length === 0) {
                        doneScrolling = true;
                        $('#loading').hide();
                        return;
                    }

                    newCards.forEach(card => document.getElementById('entries').appendChild(card));
                    page++;

                    if (xhr.getResponseHeader("X-Last-Page") === "1") {
                        doneScrolling = true;
                    }

                    loading = false;
                    $('#loading').hide();
                }
        });
    }
});

const goUpBtn = document.getElementById('goUpBtn');
window.addEventListener('scroll', () => {
    goUpBtn.style.display = window.scrollY > 300 ? 'block' : 'none';
});
goUpBtn.addEventListener('click', () => {
    window.scrollTo({ top: 0, behavior: 'smooth' });
});
</script>
{% endblock %}